<!DOCTYPE html>
<!-- saved from url=(0055)https://ncjamieson.com/avoiding-switchmap-related-bugs/ -->
<html lang="en" data-react-helmet="lang"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#2d91ca;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}h1, h1 a{font-weight:600;}a:hover{color:#357daa;}h1 a, h2 a, h3 a, h4 a{color:#219ee0;}a.gatsby-resp-image-link{box-shadow:none;}</style><style data-href="/styles.0fadeadc28585f021cb5.css">@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}a.anchor.before{box-shadow:none}.gatsby-resp-image-figcaption{font-size:80%;margin-top:14px;text-align:center}code[class*=language-],pre[class*=language-]{color:#fff;background:none;font-family:Consolas,Menlo,Monaco,source-code-pro,Courier New,monospace;font-feature-settings:normal;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;margin-bottom:0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{overflow:auto;padding:1.3125rem}pre[class*=language-]::selection{background:#27292a}pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:hsla(0,0%,100%,.15)}:not(pre)>code[class*=language-]{border-radius:.3em;background:rgba(0,0,0,.05);color:inherit;padding:.15em .2em .05em;white-space:normal}a>code[class*=language-]{background:none}.token.cdata,.token.comment,.token.prolog{color:#637777;font-style:italic}.token.punctuation{color:#c792ea}.namespace{color:#b2ccd6}.token.deleted{color:rgba(239,83,80,.56);font-style:italic}.token.property,.token.symbol{color:#80cbc4}.token.keyword,.token.operator,.token.tag{color:#7fdbca}.token.boolean{color:#ff5874}.token.number{color:#f78c6c}.token.builtin,.token.char,.token.constant,.token.function{color:#82aaff}.token.doctype,.token.selector{color:#c792ea;font-style:italic}.token.attr-name,.token.inserted{color:#addb67;font-style:italic}.language-css .token.string,.style .token.string,.token.entity,.token.string,.token.url{color:#addb67}.token.atrule,.token.attr-value,.token.class-name{color:#ffcb8b}.token.important,.token.regex,.token.variable{color:#d6deeb}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}pre[data-line]{padding:1em 0 1em 3em;position:relative}.gatsby-highlight-code-line{background-color:#022a4b;display:block;padding-right:1em;padding-left:1.25em;border-left:.25em solid #82aaff}.gatsby-highlight,.gatsby-highlight-code-line{margin-right:-1.3125rem;margin-left:-1.3125rem}.gatsby-highlight{margin-bottom:1.75rem;border-radius:10px;background:#011627;-webkit-overflow-scrolling:touch;overflow:auto}@media (max-width:672px){.gatsby-highlight{border-radius:0}ul>li>div.gatsby-highlight{margin-left:-3.0625rem}ul>li>div.gatsby-highlight>pre{margin-left:1.75rem}}.gatsby-highlight pre[class*=language-]{float:left;min-width:100%}</style><meta name="generator" content="Gatsby 2.23.11"><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script id="twitter-wjs" src="./MAP OPERATORS EXPLAINED_files/widgets.js.download"></script><script async="" src="./MAP OPERATORS EXPLAINED_files/analytics.js.download"></script><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com/"><link rel="icon" href="https://ncjamieson.com/favicon-32x32.png?v=7ed057b7eb8c9db37ff07a4e6820af3a"><link rel="manifest" href="https://ncjamieson.com/manifest.webmanifest"><meta name="theme-color" content="#03a9f4"><link rel="apple-touch-icon" sizes="48x48" href="https://ncjamieson.com/icons/icon-48x48.png?v=7ed057b7eb8c9db37ff07a4e6820af3a"><link rel="apple-touch-icon" sizes="72x72" href="https://ncjamieson.com/icons/icon-72x72.png?v=7ed057b7eb8c9db37ff07a4e6820af3a"><link rel="apple-touch-icon" sizes="96x96" href="https://ncjamieson.com/icons/icon-96x96.png?v=7ed057b7eb8c9db37ff07a4e6820af3a"><link rel="apple-touch-icon" sizes="144x144" href="https://ncjamieson.com/icons/icon-144x144.png?v=7ed057b7eb8c9db37ff07a4e6820af3a"><link rel="apple-touch-icon" sizes="192x192" href="https://ncjamieson.com/icons/icon-192x192.png?v=7ed057b7eb8c9db37ff07a4e6820af3a"><link rel="apple-touch-icon" sizes="256x256" href="https://ncjamieson.com/icons/icon-256x256.png?v=7ed057b7eb8c9db37ff07a4e6820af3a"><link rel="apple-touch-icon" sizes="384x384" href="https://ncjamieson.com/icons/icon-384x384.png?v=7ed057b7eb8c9db37ff07a4e6820af3a"><link rel="apple-touch-icon" sizes="512x512" href="https://ncjamieson.com/icons/icon-512x512.png?v=7ed057b7eb8c9db37ff07a4e6820af3a"><link rel="sitemap" type="application/xml" href="https://ncjamieson.com/sitemap.xml"><title>RxJS: Avoiding switchMap-related Bugs — @ncjamieson</title><meta data-react-helmet="true" name="description" content="Using switchMap is unsafe in many effects and epics"><meta data-react-helmet="true" property="og:title" content="RxJS: Avoiding switchMap-related Bugs"><meta data-react-helmet="true" property="og:description" content="Using switchMap is unsafe in many effects and epics"><meta data-react-helmet="true" property="og:type" content="website"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="twitter:creator" content="Nicholas Jamieson"><meta data-react-helmet="true" name="twitter:title" content="RxJS: Avoiding switchMap-related Bugs"><meta data-react-helmet="true" name="twitter:description" content="Using switchMap is unsafe in many effects and epics"><meta data-react-helmet="true" property="og:image" content="https://ncjamieson.com/static/b0cf883cefe7228c1d1a6cf0011150ef/437f5/title.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://ncjamieson.com/static/b0cf883cefe7228c1d1a6cf0011150ef/437f5/title.jpg"><meta data-react-helmet="true" name="image" content="https://ncjamieson.com/static/b0cf883cefe7228c1d1a6cf0011150ef/437f5/title.jpg"><link as="script" rel="preload" href="./MAP OPERATORS EXPLAINED_files/webpack-runtime-e19e8a5da32182e64b64.js.download"><link as="script" rel="preload" href="./MAP OPERATORS EXPLAINED_files/framework-95b680cb3190aa9bfe59.js.download"><link as="script" rel="preload" href="./MAP OPERATORS EXPLAINED_files/styles-24c541b6ac347bae38f1.js.download"><link as="script" rel="preload" href="./MAP OPERATORS EXPLAINED_files/app-fe5de850b07eb7bdf6ea.js.download"><link as="script" rel="preload" href="./MAP OPERATORS EXPLAINED_files/cc2628f0678a33ad11e2d97ea212a78ab55d641c-6b8b52a606a0f623be8e.js.download"><link as="script" rel="preload" href="./MAP OPERATORS EXPLAINED_files/e9168335fec48e0d71a06b3a2447d5e0eaeafb2f-ae746692718ac4ab0d5e.js.download"><link as="script" rel="preload" href="./MAP OPERATORS EXPLAINED_files/component---src-templates-blog-post-js-a434eae6b47f7d643b19.js.download"><link as="fetch" rel="preload" href="https://ncjamieson.com/page-data/avoiding-switchmap-related-bugs/page-data.json" crossorigin="anonymous"><link as="fetch" rel="preload" href="https://ncjamieson.com/page-data/app-data.json" crossorigin="anonymous"><style data-emotion-css="11f1a0r">@media (max-width:672px){.css-11f1a0r h1{font-size:2rem;}}</style><style data-emotion-css="dntg5y">.css-dntg5y{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;}.css-dntg5y a{box-shadow:none;margin-left:0.875rem;}.css-dntg5y a:first-of-type{margin-left:0;}.css-dntg5y img{height:16px;width:16px;}</style><style data-emotion-css="1oxgkrw">.css-1oxgkrw{background-color:#000;border-radius:10px;color:#fff;font-family:Montserrat,sans-serif;font-weight:400;margin-left:-1.3125rem;margin-right:-1.3125rem;margin-top:1.75rem;padding-left:1.3125rem;padding-right:1.3125rem;}.css-1oxgkrw p{padding-bottom:0.875rem;padding-top:0.875rem;}.css-1oxgkrw a.blm{color:#fce21b;}.css-1oxgkrw a.eji{color:#fff;}@media (max-width:672px){.css-1oxgkrw{border-radius:0;}}</style><style data-emotion-css="1f6sdsc">.css-1f6sdsc{background-color:#03a9f4;border-radius:10px;color:white;font-family:Montserrat,sans-serif;font-weight:400;margin-left:-1.3125rem;margin-right:-1.3125rem;padding-left:1.3125rem;padding-right:1.3125rem;}.css-1f6sdsc *{margin-block-end:0;margin-block-start:0;}.css-1f6sdsc form{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}.css-1f6sdsc form:last-child{padding-bottom:1.75rem;}.css-1f6sdsc input{background-color:transparent;border:1px solid rgba(255 255 255 / 30%);border-radius:4px;color:white;font-size:0.75em;outline:none;padding-bottom:2px;padding-left:8px;padding-right:8px;padding-top:2px;width:calc(40% - 0.875rem);}.css-1f6sdsc input::selection{background-color:rgba(0 0 0 / 30%);}.css-1f6sdsc input:hover{border-color:transparent;box-shadow:0 0 1px 2px rgba(255 255 255 / 50%);}.css-1f6sdsc input:focus{border-color:transparent;box-shadow:0 0 1px 2px white;}.css-1f6sdsc input[type="submit"]{border:1px solid rgba(255 255 255 / 50%);width:20%;}.css-1f6sdsc input[type="submit"]:hover{border-color:transparent;box-shadow:0 0 1px 2px 1px 2px rgba(255 255 255 / 50%);}.css-1f6sdsc input[type="submit"]:focus{border-color:transparent;box-shadow:0 0 1px 2px white;}.css-1f6sdsc p{padding-bottom:0.875rem;padding-top:0.875rem;}@media (max-width:672px){.css-1f6sdsc{border-radius:0;}.css-1f6sdsc input[type]{margin-top:0.875rem;width:100%;}.css-1f6sdsc input:first-of-type{margin-top:0;}}.css-1f6sdsc .banner{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}.css-1f6sdsc .banner a{color:white;font-size:0.5em;}</style><script type="text/javascript"><br>    window.twttr = (function(d, s, id) {<br>      var js,<br>        fjs = d.getElementsByTagName(s)[0],<br>        t = window.twttr || {};<br>      if (d.getElementById(id)) return t;<br>      js = d.createElement(s);<br>      js.id = id;<br>      js.src = "https://platform.twitter.com/widgets.js";<br>      fjs.parentNode.insertBefore(js, fjs);<br>      t._e = [];<br>      t.ready = function(f) {<br>        t._e.push(f);<br>      };<br>      return t;<br>    })(document, "script", "twitter-wjs");<br>  </script><link rel="prefetch" href="https://ncjamieson.com/page-data/index/page-data.json" crossorigin="anonymous" as="fetch"><script charset="utf-8" src="./MAP OPERATORS EXPLAINED_files/horizon_tweet.278dff0e94964f51fb3a8a312fe19019.js.download"></script><link rel="prefetch" href="https://ncjamieson.com/component---src-pages-index-js-362d4abac4e7d9d6cc0b.js"></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem" class="css-11f1a0r"><header><h3 style="margin-top:0"><a style="box-shadow:none;text-decoration:none" href="https://ncjamieson.com/">@ncjamieson</a></h3></header><main><article><header><h1 style="margin-top:1.75rem;margin-bottom:0">RxJS: Avoiding switchMap-related Bugs</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem">March 12, 2018<!-- --> • <!-- -->7<!-- --> minute read</p></header><section><p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; ">
      <span class="gatsby-resp-image-background-image" style="padding-bottom: 75%; position: relative; bottom: 0px; left: 0px; background-image: url(&quot;data:image/jpeg;base64,/9j/2wBDAAIBAQEBAQIBAQECAgICAgQDAgICAgUEBAMEBgUGBgYFBgYGBwkIBgcJBwYGCAsICQoKCgoKBggLDAsKDAkKCgr/2wBDAQICAgICAgUDAwUKBwYHCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgr/wgARCAAPABQDAREAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAwYEBQf/xAAYAQADAQEAAAAAAAAAAAAAAAAAAQIDBP/aAAwDAQACEAMQAAABx/ozs5ES0YJqaOz/xAAaEAACAwEBAAAAAAAAAAAAAAADBQEEBgIR/9oACAEBAAEFAlEYfwt3A2oOJDcMsa58nFjVZgo2DxTJf//EABgRAQEBAQEAAAAAAAAAAAAAAAEAIRAR/9oACAEDAQE/AQbzm2wN/8QAGREAAwEBAQAAAAAAAAAAAAAAAAERAhIh/9oACAECAQE/AXtHYtJkrIeH/8QAKRAAAgEBBgQHAQAAAAAAAAAAAQIDEQAEBRIhMSIjUWEGFDIzQaGx4f/aAAgBAQAGPwKNHx1C0usSrd5KnqfTtvqellF0x0sbw9IMlyfmkb5eH7NBZpMPv08yA0Lw4ezCtr3FLhGZshL89hwKQNKbfy2ZfDajzkWX3TwLQadvkadO9lRMHACxgUE7j8t//8QAGxABAQADAQEBAAAAAAAAAAAAAREAITFBUWH/2gAIAQEAAT8hVf8ALwlj5IcGGqJ6NGhNBP0Hema/6aB0qFefmHHRPbXCHjcIM3Cd8gmhbQ6v29YOnIAHvxbavauf/9oADAMBAAIAAwAAABBM6b//xAAYEQEBAQEBAAAAAAAAAAAAAAABABEhcf/aAAgBAwEBPxAB22EiMpBs35JNv//EABwRAAIDAAMBAAAAAAAAAAAAAAABESExQXGhwf/aAAgBAgEBPxB10tLvsST8IQpLkWctDhUL0//EABkQAQEBAQEBAAAAAAAAAAAAAAERACExQf/aAAgBAQABPxCbfvywlIlLDtLLruNdjCkrhgyqWJ8dM2PCgaQqiLbr5McDm1agchxwyXN3uEQwXFCKLhubeI37BdQVQu//2Q==&quot;); background-size: cover; display: block; transition: opacity 0.5s ease 0.5s; opacity: 0;"></span>
  <img class="gatsby-resp-image-image" alt="Shopping trolley" title="Shopping trolley" src="./MAP OPERATORS EXPLAINED_files/title.jpg" srcset="/static/b0cf883cefe7228c1d1a6cf0011150ef/6aa9a/title.jpg 148w,
/static/b0cf883cefe7228c1d1a6cf0011150ef/3e520/title.jpg 295w,
/static/b0cf883cefe7228c1d1a6cf0011150ef/accd5/title.jpg 590w,
/static/b0cf883cefe7228c1d1a6cf0011150ef/5fd6b/title.jpg 800w" sizes="(max-width: 590px) 100vw, 590px" style="width: 100%; height: 100%; margin: 0px; vertical-align: middle; position: absolute; top: 0px; left: 0px; opacity: 1; transition: opacity 0.5s ease 0s; color: inherit; box-shadow: white 0px 0px 0px 400px inset;" loading="lazy">
    </span></p>
<p>A while ago, <a href="https://twitter.com/victorsavkin" target="_blank" rel="nofollow noopener noreferrer">Victor Savkin</a> tweeted about a subtle bug that occurs through the misuse of <code class="language-text">switchMap</code> in NgRx effects in Angular applications:</p>
<div class="twitter-tweet twitter-tweet-rendered" style="display: flex; max-width: 550px; width: 100%; margin-top: 10px; margin-bottom: 10px;"><iframe id="twitter-widget-0" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" class="" style="position: static; visibility: visible; width: 550px; height: 223px; display: block; flex-grow: 1;" title="Twitter Tweet" src="./MAP OPERATORS EXPLAINED_files/index.html" data-tweet-id="963486303118557185"></iframe></div>
<h2 id="so-whats-the-bug" style="position:relative;"><a href="https://ncjamieson.com/avoiding-switchmap-related-bugs/#so-whats-the-bug" aria-label="so whats the bug permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>So what’s the&nbsp;bug?</h2>
<p>Let’s use a shopping cart as an example and have a look at an effect — and an epic — that misuses <code class="language-text">switchMap</code> and then consider some alternative operators.</p>
<p>Here’s an NgRx effect that misuses <code class="language-text">switchMap</code>:</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">@<span class="token function">Effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> removeFromCart <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
  <span class="token function">ofType</span><span class="token punctuation">(</span>CartActionTypes<span class="token punctuation">.</span>RemoveFromCart<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">switchMap</span><span class="token punctuation">(</span><span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>backend
    <span class="token punctuation">.</span><span class="token function">removeFromCart</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>payload<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">RemoveFromCartFulfilled</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">catchError</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token keyword">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RemoveFromCartRejected</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>And here’s its equivalent <code class="language-text">redux-observable</code> epic:</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token function-variable function">removeFromCart</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">actions$</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  actions$<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
    <span class="token function">ofType</span><span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token constant">REMOVE_FROM_CART</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">switchMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      backend<span class="token punctuation">.</span><span class="token function">removeFromCart</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
        <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> actions<span class="token punctuation">.</span><span class="token function">removeFromCartFulfilled</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">catchError</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">of</span><span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token function">removeFromCartRejected</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Our shopping cart lists the items the user intends to purchase and against each item is a button that removes the item from the cart. Clicking the button dispatches a <code class="language-text">RemoveFromCart</code> action to the effect/epic which communicates with the application’s backend and sees the item removed from the cart.</p>
<p>Most of the time, this will function as intended. However, the use of <code class="language-text">switchMap</code> has introduced a race condition.</p>
<p>If the user clicks the remove buttons for several items in the cart, what happens depends upon how rapidly the buttons are clicked.</p>
<p>If a remove button is clicked when the effect/epic is communicating with the backend — that is, when a removal is pending — the use of <code class="language-text">switchMap</code> will see the pending removal aborted.</p>
<p>So, depending upon how rapidly the buttons are clicked, the application might:</p>
<ul>
<li>remove all of the clicked items from the cart;</li>
<li>remove only some of the clicked items from the cart; or</li>
<li>remove some of the clicked items from the backend’s cart but not reflect their removal from the frontend’s cart.</li>
</ul>
<p>Clearly, this is a bug.</p>
<p>It’s unfortunate that <code class="language-text">switchMap</code> is often suggested as the first choice when a flattening operator is required, as it’s not safe for all scenarios.</p>
<p>RxJS has four flattening operators to choose from:</p>
<ul>
<li><code class="language-text">mergeMap</code> (also known as <code class="language-text">flatMap</code>);</li>
<li><code class="language-text">concatMap</code>;</li>
<li><code class="language-text">switchMap;</code> and</li>
<li><code class="language-text">exhaustMap</code>.</li>
</ul>
<p>Let’s have a look at these operators to see how they differ and to determine the shopping-cart scenarios for which each operator is best suited.</p>
<h2 id="mergemapflatmap" style="position:relative;"><a href="https://ncjamieson.com/avoiding-switchmap-related-bugs/#mergemapflatmap" aria-label="mergemapflatmap permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mergeMap/flatMap</h2>
<p>If <code class="language-text">switchMap</code> is replaced with <code class="language-text">mergeMap</code>, the effect/epic will concurrently handle each dispatched action. That is, pending removals will not be aborted; the backend requests will occur concurrently and, when fulfilled, the response actions will be dispatched.</p>
<p>It’s important to note that due to the concurrent handling of the actions, the order of the responses might not match the order of the requests. For example, if the user clicks the remove buttons of the first and second items, it’s possible that the removal of the second item might occur before the removal of the first.</p>
<p>With our cart, the ordering of the removals doesn’t matter, so using <code class="language-text">mergeMap</code> instead of <code class="language-text">switchMap</code> fixes the bug.</p>
<h2 id="concatmap" style="position:relative;"><a href="https://ncjamieson.com/avoiding-switchmap-related-bugs/#concatmap" aria-label="concatmap permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>concatMap</h2>
<p>The order in which items are removed from the cart might not matter, but there are often actions for which the ordering is important.</p>
<p>For example, if our shopping cart has a button for increasing an item’s quantity, it’s important that the dispatched actions are handled in the correct order. Otherwise, the quantities in the frontend’s cart could end up out-of-sync with the quantities in the backend’s cart.</p>
<p>With actions for which the ordering is important, <code class="language-text">concatMap</code> should be used. <code class="language-text">concatMap</code> is the equivalent of using <code class="language-text">mergeMap</code> with a concurrency of one. That is, an effect/epic using <code class="language-text">concatMap</code> will be processing only one backend request at a time — and actions are queued in the order in which they are dispatched.</p>
<p><code class="language-text">concatMap</code> is a safe, conservative choice. If you are unsure of which flattening operator to use in an effect/epic, use <code class="language-text">concatMap</code>.</p>
<h2 id="switchmap" style="position:relative;"><a href="https://ncjamieson.com/avoiding-switchmap-related-bugs/#switchmap" aria-label="switchmap permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>switchMap</h2>
<p>The use of <code class="language-text">switchMap</code> will see pending backend requests aborted whenever an action of the same type is dispatched. That makes <code class="language-text">switchMap</code> unsafe for create, update and delete actions. However, it can also introduce bugs for read actions.</p>
<p>Whether or not <code class="language-text">switchMap</code> is appropriate for a particular read action depends upon whether or not the backend response is still required after another action of the same type is dispatched. Let’s look at an action with which the use of <code class="language-text">switchMap</code> would introduce a bug.</p>
<p>If each item in our shopping cart has a details button — for showing some inline details — and the effect/epic that handles the details action uses <code class="language-text">switchMap</code>, a race condition is introduced. If the user clicks the details buttons of several items, whether or not the details for those items will be displayed depends upon how rapidly the user clicks the buttons.</p>
<p>As with the <code class="language-text">RemoveFromCart</code> action, using <code class="language-text">mergeMap</code> would fix the bug.</p>
<p><code class="language-text">switchMap</code> should only be used in effects/epics for read actions and only when the backend response is not required after another action of the same type is dispatched.</p>
<p>Let’s look at a scenario in which <code class="language-text">switchMap</code> would be useful.</p>
<p>If our application’s cart shows the total cost of the items plus the shipping, each change to the cart’s content would see a <code class="language-text">GetCartTotal</code> action dispatched. Using <code class="language-text">switchMap</code> for the effect/epic that handles the <code class="language-text">GetCartTotal</code> action would be entirely appropriate.</p>
<p>If the cart is changed whilst the effect/epic is handling a <code class="language-text">GetCartTotal</code> action, the response to the pending request will be stale — it’ll be the total for the items in the cart prior to the change — so aborting the pending request is of no consequence. In fact, aborting is preferable to allowing the pending request to complete and then ignoring — or, worse, rendering — the stale response.</p>
<h2 id="exhaustmap" style="position:relative;"><a href="https://ncjamieson.com/avoiding-switchmap-related-bugs/#exhaustmap" aria-label="exhaustmap permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>exhaustMap</h2>
<p><code class="language-text">exhaustMap</code> is perhaps the least-well-known of the flattening operators, but it’s easily explained: it can be thought of as the opposite of <code class="language-text">switchMap</code>.</p>
<p>If <code class="language-text">switchMap</code> is used, pending backend requests are aborted in favour of more recently dispatched actions. However, if <code class="language-text">exhaustMap</code> is used, dispatched actions are ignored whilst there is a pending backend request.</p>
<p>Let’s look at a scenario in which <code class="language-text">exhaustMap</code> could be used.</p>
<p>There’s a particular type of user with whom developers should be familiar: the incessant button clicker. When the incessant button clicker clicks a button and nothing happens, they click it again. And again. And again.</p>
<p>If our shopping cart has a refresh button and the effect/epic that handles the refresh uses <code class="language-text">switchMap</code>, each incessant button click will abort the pending refresh. That doesn’t make a whole lot of sense and the incessant button clicker could be clicking for a long, long time before a refresh occurs.</p>
<p>If the effect/epic that handles the refreshing of the cart instead used <code class="language-text">exhaustMap</code>, a pending refresh request would see the incessant clicks ignored.</p>
<h2 id="tldr" style="position:relative;"><a href="https://ncjamieson.com/avoiding-switchmap-related-bugs/#tldr" aria-label="tldr permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TL;DR</h2>
<p>To summarise, when you need to use a flattening operator in an effect/epic you should:</p>
<ul>
<li>use <code class="language-text">concatMap</code> with actions that should be neither aborted nor ignored and for which the ordering must be preserved — it’s also a conservative choice that will always behave in a predictable manner;</li>
<li>use <code class="language-text">mergeMap</code> with actions that should be neither aborted nor ignored and for which the ordering is unimportant;</li>
<li>use <code class="language-text">switchMap</code> with read actions that should be aborted when another action of the same type is dispatched; and</li>
<li>use <code class="language-text">exhaustMap</code> with actions that should be ignored whilst an action of the same type is pending.</li>
</ul>
<h2 id="using-tslint-to-avoid-switchmap-misuse" style="position:relative;"><a href="https://ncjamieson.com/avoiding-switchmap-related-bugs/#using-tslint-to-avoid-switchmap-misuse" aria-label="using tslint to avoid switchmap misuse permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using TSLint to avoid switchMap misuse</h2>
<p>I’ve added an <code class="language-text">rxjs-no-unsafe-switchmap</code> rule to the <a href="https://github.com/cartant/rxjs-tslint-rules" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">rxjs-tslint-rules</code></a> package.</p>
<p>The rule recognises NgRx effects and <code class="language-text">redux-observable</code> epics, determines their action types and then searches for particular verbs within the action types (e.g. <code class="language-text">add</code>, <code class="language-text">update</code>, <code class="language-text">remove</code>, etc.). It has some sensible defaults and <a href="https://github.com/cartant/rxjs-tslint-rules#rxjs-no-unsafe-switchmap" target="_blank" rel="nofollow noopener noreferrer">can be configured</a> if the defaults are too general.</p>
<p>After enabling the rule and running TSLint over some applications I wrote last year, I found more than a few effects that used <code class="language-text">switchMap</code> in an unsafe manner. So thanks for your tweet, Victor.</p></section><hr style="margin-bottom:1.75rem"><footer><div style="display:flex;margin-bottom:0"><a href="https://ncjamieson.com/about" style="box-shadow:none;text-decoration:none"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAA7DiAAOw4gGksCT+AAACmElEQVQ4y11VzW7TQBBe7woEOXEBbojXapDIhRPvQA8IAUfUcgkP0NiUBARqcoc+AuJGpD4BYDttwc4O883MOo4jjXYynvn8zc6Pnc9rh58vahfyOjN9FIr6ccirOdsu+GxUoNcLfjbhuJH45lUWDCOdAMic6/QDlnX4TCRyek0MoALd7Ay0Ztu4izMywqwHdiQBi4Z8wYwKYbXlM3JwFD2vG/Zr4CO+HNMDZZrGjv8chSU7cGoc0ArAQPxOZ4Z1Ky9dgq2C8os7lgeWRsOylYDZnyiSV13K0JPd/m8RY7HjBDaSO0MKygwPY/jYUvgUaQgIG56Jj9pavaJ6DSxUaWJ30UhaeRnD/B/5V+fkD1cUPlwrM4BBP1zys28kPvCVGGXJKU9Q6nkC9DMBi/7tD3I3bhEnQP7ZmTAKi1bAYHM3R+SPv5P4zkoUsLVsVkj5Au3A51beCBbv1uTuPuDA2+RffuXARhkxM9jcvYfkpz+NfWmF2oBUheo2VjWjX2owgwqL0yvyJ79ERGebn65TypSqnk6n/VaDduxdtATLVXwZiDT7VVesFBPsBOCFTQNaIGprlF2K2ZM3lD2dqrDuX59zqn+FnRVrP+VUFOl+mQgGRXpnRNn4Ob8xkLtzXyXzlD16IUz9ye9d66SiFChKzktAADV1awNLp0Qj74ve2x47qYN2ygSAXWNjnIag4f0ly8bkctfgaQQxDP3GtjkeW2Py6NXbHmhMTd2T3jzLmNro2ebpdmBaDoVsk9bvGAyXBNmiaLF5ZDnYxuFKZy4t2OH6CtqfbQ8ENqywVu7M1pcfrq+95WjpdwsWi0DbIWqfbdRmC5YLOe6RyfZQce4+ARU+AROWFXqrx7Bi4JV8AqwASJP97foq9x+LKG9SQkDcjQAAAABJRU5ErkJggg==" alt="Nicholas Jamieson" style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; object-fit: cover; object-position: center center; opacity: 0; transition-delay: 500ms; border-radius: 50%; margin-bottom: 0px;"><picture><source srcset="/static/7ed057b7eb8c9db37ff07a4e6820af3a/318fd/ncjamieson.png 1x,
/static/7ed057b7eb8c9db37ff07a4e6820af3a/bed6f/ncjamieson.png 1.5x,
/static/7ed057b7eb8c9db37ff07a4e6820af3a/064bf/ncjamieson.png 2x"><img srcset="/static/7ed057b7eb8c9db37ff07a4e6820af3a/318fd/ncjamieson.png 1x,
/static/7ed057b7eb8c9db37ff07a4e6820af3a/bed6f/ncjamieson.png 1.5x,
/static/7ed057b7eb8c9db37ff07a4e6820af3a/064bf/ncjamieson.png 2x" src="./MAP OPERATORS EXPLAINED_files/ncjamieson.png" alt="Nicholas Jamieson" width="50" height="50" loading="lazy" style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; object-fit: cover; object-position: center center; opacity: 1; transition: opacity 500ms ease 0s; border-radius: 50%; margin-bottom: 0px;"></picture><noscript><picture><source srcset="/static/7ed057b7eb8c9db37ff07a4e6820af3a/318fd/ncjamieson.png 1x,
/static/7ed057b7eb8c9db37ff07a4e6820af3a/bed6f/ncjamieson.png 1.5x,
/static/7ed057b7eb8c9db37ff07a4e6820af3a/064bf/ncjamieson.png 2x" /><img loading="lazy" width="50" height="50" srcset="/static/7ed057b7eb8c9db37ff07a4e6820af3a/318fd/ncjamieson.png 1x,
/static/7ed057b7eb8c9db37ff07a4e6820af3a/bed6f/ncjamieson.png 1.5x,
/static/7ed057b7eb8c9db37ff07a4e6820af3a/064bf/ncjamieson.png 2x" src="/static/7ed057b7eb8c9db37ff07a4e6820af3a/318fd/ncjamieson.png" alt="Nicholas Jamieson" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></a><p style="margin:0">Personal blog by <!-- -->Nicholas Jamieson<!-- -->.<br>Mostly articles about RxJS, TypeScript and React.<br><span class="css-dntg5y"><a href="https://github.com/cartant"><img src="./MAP OPERATORS EXPLAINED_files/github.svg" alt="GitHub"></a><a href="https://twitter.com/ncjamieson"><img src="./MAP OPERATORS EXPLAINED_files/twitter.svg" alt="Twitter"></a></span></p></div><div class="css-1oxgkrw"><p><a class="blm" href="https://blacklivesmatter.com/">Black Lives Matter</a> <!-- -->—<!-- --> <a class="eji" href="https://support.eji.org/give/153413/#!/donation/checkout">Equal Justice Initiative</a></p></div><div style="margin:1.75rem 0"><div class="css-1f6sdsc"><div class="banner"><p>Join my weekly newsletter</p><p><a href="https://ncjamieson.com/privacy" target="_blank">Privacy Policy</a></p></div><form autocomplete="off"><input type="text" placeholder="First name" value="" spellcheck="false"><input type="email" placeholder="Email" required="" value="" spellcheck="false"><input type="submit" value="Subscribe"></form></div></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="https://ncjamieson.com/understanding-expand/">← <!-- -->RxJS: Understanding Expand</a></li><li><a rel="next" href="https://ncjamieson.com/when-to-use-switchmap/">RxJS: When to Use switchMap<!-- --> →</a></li></ul></nav></main><footer style="display:flex;justify-content:space-between"><span>© <!-- -->2020<!-- --> <!-- -->Nicholas Jamieson<!-- --> <!-- -->All&nbsp;Rights&nbsp;Reserved</span><a style="box-shadow:none;text-decoration:none" href="https://ncjamieson.com/rss.xml">RSS</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-103034213-3', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/avoiding-switchmap-related-bugs/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-fe5de850b07eb7bdf6ea.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-7c31e2436cade51cbcda.js"],"component---src-pages-404-js":["/component---src-pages-404-js-7140b5a8513c4509aa61.js"],"component---src-pages-about-js":["/component---src-pages-about-js-2a0c5ad8f775ac06be87.js"],"component---src-pages-index-js":["/component---src-pages-index-js-362d4abac4e7d9d6cc0b.js"],"component---src-pages-privacy-js":["/component---src-pages-privacy-js-41d5cabe67389ccad61b.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-a434eae6b47f7d643b19.js"],"component---src-templates-newsletter-js":["/component---src-templates-newsletter-js-cdec8ce2ab198df6962d.js"]};/*]]>*/</script><script src="./MAP OPERATORS EXPLAINED_files/component---src-templates-blog-post-js-a434eae6b47f7d643b19.js.download" async=""></script><script src="./MAP OPERATORS EXPLAINED_files/e9168335fec48e0d71a06b3a2447d5e0eaeafb2f-ae746692718ac4ab0d5e.js.download" async=""></script><script src="./MAP OPERATORS EXPLAINED_files/cc2628f0678a33ad11e2d97ea212a78ab55d641c-6b8b52a606a0f623be8e.js.download" async=""></script><script src="./MAP OPERATORS EXPLAINED_files/app-fe5de850b07eb7bdf6ea.js.download" async=""></script><script src="./MAP OPERATORS EXPLAINED_files/styles-24c541b6ac347bae38f1.js.download" async=""></script><script src="./MAP OPERATORS EXPLAINED_files/framework-95b680cb3190aa9bfe59.js.download" async=""></script><script src="./MAP OPERATORS EXPLAINED_files/webpack-runtime-e19e8a5da32182e64b64.js.download" async=""></script><iframe scrolling="no" frameborder="0" allowtransparency="true" src="./MAP OPERATORS EXPLAINED_files/widget_iframe.c4b33f07650267db9f8a72eaac551cac.html" title="Twitter settings iframe" style="display: none;"></iframe></body></html>